<ion-page>
  <ion-header>
    <ion-toolbar>
      <ion-title>Main Page</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content class="ion-padding">
    <ion-button color="secondary" @click="goViewDeck" style="width:100%;margin-bottom:12px">View Deck</ion-button>
    <template v-if="!(connectedHost || connectedClient)">
      <div style="display:flex;text-align: center; gap:10px;width:100%;height:256px">
        <ion-button
          :color="activeRole === 'server' ? 'primary' : 'medium'"
          :fill="activeRole === 'server' ? 'solid' : 'outline'"
          @click="setRole('server')"
          style="flex:1"
        >
          <ion-icon :icon="serverOutline" style="font-size:128px;display:block;margin:0 auto"></ion-icon>
        </ion-button>
        <ion-button
          :color="activeRole === 'client' ? 'primary' : 'medium'"
          :fill="activeRole === 'client' ? 'solid' : 'outline'"
          @click="setRole('client')"
          style="flex:1"
        >
          <ion-icon :icon="phonePortraitOutline" style="font-size:128px;display:block;margin:0 auto"></ion-icon>
        </ion-button>
        <ion-button
          :color="activeRole === 'local' ? 'primary' : 'medium'"
          :fill="activeRole === 'local' ? 'solid' : 'outline'"
          @click="goLocalPlayer"
          style="flex:1"
        >
          <ion-icon :icon="cubeOutline" style="font-size:128px;display:block;margin:0 auto"></ion-icon>
        </ion-button>
      </div>
    </template>
    <p v-if="!activeRole" style="margin:0 0 12px 0">Choose a role to continue.</p>

    <template v-if="activeRole === 'server' && !connectedHost">      
      <ion-button @click="createOffer" color="success" style="width:100%">Create Offer & QR</ion-button>
      <div v-if="offerQrParts.length && !scanning" style="display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;margin-top:8px">
        <div
          v-for="idx in offerQrParts.length"
          :key="`offer-part-${idx}`"
          :style="`min-width:52px;padding:6px 8px;border-radius:6px;text-align:center;border:1px solid ${scannedParts[idx - 1] ? '#495057' : '#ced4da'};background:${scannedParts[idx - 1] ? '#e9ecef' : '#f8f9fa'};color:${scannedParts[idx - 1] ? '#212529' : '#adb5bd'};display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px`"
        >
          <ion-icon :icon="offerQrPartIndex === (idx - 1) ? cube : cubeOutline" style="font-size:18px"></ion-icon>
          <span style="font-size:11px;line-height:1">{{ idx }}</span>
        </div>
      </div>

      <div v-if="offerQr && !scanning" style="margin-top:8px">
        <img :src="offerQr" alt="offer-qr" style="width:100%;display:block"/>
        <ion-button color="success" @click="startScanner('answer')" style="width:100%">Scan Answer QR (camera)</ion-button>
      </div>
    </template>

    <template style="margin: 12px 0"
      v-if="connectedClient || connectedHost">
      <p><strong>Data channel open</strong></p>
      <div v-if="activeRole === 'client' && clientHandCards.length" style="margin:12px 0px">
        <p><strong>Your initial 5 cards</strong></p>
        <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:6px">
          <div v-for="(card, idx) in clientHandCards" :key="`client-hand-${idx}-${card.title || 'card'}`" style="min-width:230px;max-width:230px;flex:0 0 auto">
            <CardItem :card="card" :showExport="false" />
          </div>
        </div>
      </div>
      <div v-if="activeRole === 'server' && serverHandCards.length" style="margin:12px 0px">
        <p><strong>Server dealt cards</strong></p>
        <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:6px">
          <div v-for="(card, idx) in serverHandCards" :key="`server-hand-${idx}-${card.title || 'card'}`" style="min-width:230px;max-width:230px;flex:0 0 auto">
            <CardItem :card="card" :showExport="false" />
          </div>
        </div>
      </div>
      <p>Send message to peer:</p>
      <textarea v-model="outgoingText" rows="2" style="width:100%"></textarea>
      <ion-button @click="sendMessage(activeRole === 'client' ? 'client' : 'host')" style="margin-top:6px;width:100%">Send</ion-button>
    </template> 

    <template style="margin:12px 0px"
      v-if="activeRole === 'client' && !connectedClient">
      <ion-button color="success" @click="startScanner('offer')" style="width:100%">Scan Server Offer QR (camera)</ion-button>
      <div v-if="sdpText" style="margin:12px 0px">
        <ion-button @click="acceptOffer(sdpText)" style="margin-top:6px;width:100%">Generate Answer QR</ion-button>
      </div>
      <div v-if="answerQrParts.length && !scanning"
                  style="margin:12px 0px">
        <img :src="answerQr" alt="answer-qr" style="width:100%;display:block"/>
        <p v-if="answerQrParts.length" style="margin:6px 0 6px 0">Part {{ answerQrPartIndex + 1 }}/{{ answerQrParts.length }}</p>
        <div v-if="answerQrParts.length" style="display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto">
          <div
            v-for="idx in answerQrParts.length"
            :key="`answer-part-${idx}`"
            :style="`min-width:52px;padding:6px 8px;border-radius:6px;text-align:center;border:1px solid ${scannedParts[idx - 1] ? '#495057' : '#ced4da'};background:${scannedParts[idx - 1] ? '#e9ecef' : '#f8f9fa'};color:${scannedParts[idx - 1] ? '#212529' : '#adb5bd'};display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px`"
          >
            <ion-icon :icon="answerQrPartIndex === (idx - 1) ? cube : cubeOutline" style="font-size:18px"></ion-icon>
            <span style="font-size:11px;line-height:1">{{ idx }}</span>
          </div>
        </div>
      </div>

      <div v-if="connectedClient" style="margin:12px 0px">
        <p><strong>Data channel open (client)</strong></p>
      </div>
      <div v-if="connectedClient" style="margin:12px 0px">
        <p>Send message to peer:</p>
        <textarea v-model="outgoingText" rows="2" style="width:100%"></textarea>
        <ion-button @click="sendMessage('client')" style="margin-top:6px;width:100%">Send</ion-button>
      </div>

    </template>

    <template style="margin:12px 0"
      v-if="scanning && !((activeRole === 'server' && connectedHost) || (activeRole === 'client' && connectedClient))">
      <div style="display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto">
        <div
          v-for="idx in scannedPartsExpected"
          :key="idx"
          :style="`min-width:52px;padding:6px 8px;border-radius:6px;text-align:center;border:1px solid ${scannedParts[idx - 1] ? '#495057' : '#ced4da'};background:${scannedParts[idx - 1] ? '#e9ecef' : '#f8f9fa'};color:${scannedParts[idx - 1] ? '#212529' : '#adb5bd'};display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px`"
        >
          <ion-icon :icon="scannedParts[idx - 1] ? cube : cubeOutline" style="font-size:18px"></ion-icon>
          <span style="font-size:11px;line-height:1">{{ idx }}</span>
        </div>
      </div>
      <div id="qr-reader" style="width:100%"></div>
      <p v-if="scanStatus">{{ scanStatus }}</p>
      <ion-button color="medium" @click="resetScannedParts" style="margin:12px 0;width:100%">Clear Scanned Parts</ion-button>
      <ion-button color="danger" @click="stopScanner" style="margin:12px 0;width:100%">Stop Scanner</ion-button>
    </template>
    <template v-if="scanError">
      {{ scanError }}
    </template>
    <template v-if="consoleLogger.length">
      <p><strong>Logs</strong></p>
      <div v-for="(log, idx) in consoleLogger" :key="idx" style="width:100%;background:#f6f6f8;white-space:pre-wrap; padding:8px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;line-height:1.3">
        {{ log }}
      </div>
    </template>
  </ion-content>
</ion-page>
